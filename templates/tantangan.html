<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Challenge - Skripsi</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            position: relative;
        }
        
        /* TOMBOL KEMBALI */
        .back-link {
            position: absolute; top: 20px; left: 20px;
            text-decoration: none; color: #555; font-weight: bold; font-size: 0.9em;
            background: white; padding: 8px 15px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s;
        }
        .back-link:hover { color: #007bff; transform: translateX(-3px); }

        .container {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 600px;
            text-align: center;
        }
        h1 { color: #0056b3; margin-bottom: 5px; }
        
        .progress-container {
            background-color: #eee; border-radius: 10px; height: 10px;
            margin: 20px 0; width: 100%; overflow: hidden;
        }
        .progress-bar {
            background-color: #2ECC40; height: 100%; width: 14%; /* 100/7 = ~14% */
            transition: width 0.5s ease;
        }
        .level-badge {
            background: #007bff; color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 0.9em; font-weight: bold;
            display: inline-block; margin-bottom: 15px;
        }
        .instruction { font-size: 1.1em; margin-bottom: 20px; min-height: 60px; line-height: 1.5; }
        
        .input-wrapper {
            position: relative; width: 95%; margin: 0 auto 15px auto; height: 48px;
        }
        #challenge-input {
            width: 100%; height: 100%; padding: 0 45px 0 15px; font-size: 1em;
            border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
        }
        #toggle-password {
            position: absolute; right: 15px; top: 0; bottom: 0; margin: auto;
            display: flex; align-items: center; justify-content: center;
            width: 30px; height: 100%; cursor: pointer; opacity: 0.6; z-index: 10;
        }
        #toggle-password svg { width: 22px; height: 22px; fill: #666; }

        #next-btn {
            width: 95%; padding: 12px 20px; font-size: 1.1em; font-weight: bold;
            background-color: #007bff; color: white; border: none;
            border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;
        }
        #next-btn:hover { background-color: #0056b3; }

        #message-area { margin-top: 15px; font-weight: bold; min-height: 20px; }
        .error { color: #D8000C; }
        .success { color: #2ECC40; }
    </style>
</head>
<body>

    <a href="/" class="back-link">‚Üê Kembali ke Menu Utama</a>

    <div class="container">
        <h1>Mode Tantangan</h1>
        <div class="level-badge">Level <span id="level-num">1</span>/7</div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <p class="instruction" id="instruction-text">
            <strong>Tugas:</strong> Buat password dasar dengan panjang minimal 8 karakter.
        </p>

        <div class="input-wrapper">
            <input type="password" id="challenge-input" placeholder="Ketik di sini...">
            <span id="toggle-password" title="Tampilkan Password">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </span>
        </div>

        <button id="next-btn">Cek & Lanjut</button>
        <p id="message-area"></p>
    </div>

    <script>
        let currentLevel = 1;
        let savedPassword = ""; 

        // UPDATE: Definisi 7 Level
        const levels = {
            1: "Langkah 1 (Dasar): Buat kata sandi dengan panjang minimal 8 karakter.",
            2: "Langkah 2 (Variasi): Perkuat kata sandi tersebut. Tambahkan setidaknya satu Angka dan satu Simbol.",
            3: "Langkah 3 (Kapital): Tambahkan satu Huruf Kapital (Huruf Besar).",
            4: "Langkah 4 (Pola): Hindari pola keyboard (qwerty), urutan (123/abc), atau pengulangan (aaa) saat membuat kata sandi.",
            5: "Langkah 5 (Kamus): Pastikan kata sandi tidak terdeteksi sebagai kata umum / kata sandi yang pernah bocor (Dictionary Attack).",
            6: "Langkah 6 (Hybrid): Hindari pola Hybrid (Kata+Angka) seperti 'pass123'. Buat lebih acak.",
            7: "Langkah 7 (Ingatan): Masukkan ulang kata sandi terakhir Anda dari level 6."
        };

        const input = document.getElementById('challenge-input');
        const msg = document.getElementById('message-area');
        const btn = document.getElementById('next-btn');
        const levelNum = document.getElementById('level-num');
        const instrText = document.getElementById('instruction-text');
        const progressBar = document.getElementById('progress-bar');
        const toggleBtn = document.getElementById('toggle-password');

        btn.addEventListener('click', function() {
            const password = input.value;
            msg.textContent = "Menganalisis...";
            msg.className = "";

            if (!password || password.trim() === "") {
                msg.textContent = "Error: Kata sandi tidak boleh kosong!";
                msg.className = "error";
                return;
            }

            // Khusus Level Terakhir (7) - Cek Lokal
            if (currentLevel === 7) {
                if (password === savedPassword) {
                    msg.textContent = "SELAMAT! Anda lulus semua tantangan.";
                    msg.className = "success";
                    btn.textContent = "Selesai (Ulangi)";
                    input.disabled = true;
                    setTimeout(() => { if(confirm("Tantangan Selesai! Mau coba lagi?")) location.reload(); }, 2000);
                } else {
                    msg.textContent = "Salah! Password tidak cocok dengan yang Anda buat di Level 6.";
                    msg.className = "error";
                }
                return;
            }

            fetch("/analyze", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "password": password })
            })
            .then(res => res.json())
            .then(data => {
                let passed = false;
                let errorText = "";

                if (data.weaknesses.includes("INVALID_INPUT")) {
                    msg.textContent = "Error: Input tidak valid."; msg.className = "error"; return;
                }

                // --- LOGIKA PER LEVEL (UPDATED) ---

                // Level 1: Panjang
                if (currentLevel === 1) {
                    if (data.weaknesses.includes("BRUTEFORCE_LENGTH")) { 
                        errorText = "Gagal: Password masih kurang dari 8 karakter."; 
                    } else { passed = true; }
                }
                
                // Level 2: Angka & Simbol
                else if (currentLevel === 2) {
                    if (data.weaknesses.includes("BRUTEFORCE_NO_NUMBER") || data.weaknesses.includes("BRUTEFORCE_NO_SYMBOL")) { 
                        errorText = "Gagal: Harus ada Angka DAN Simbol."; 
                    } else { passed = true; }
                }

                // Level 3: Kapital
                else if (currentLevel === 3) {
                    if (data.weaknesses.includes("BRUTEFORCE_NO_UPPER")) { 
                        errorText = "Gagal: Belum ada Huruf Kapital."; 
                    } else { passed = true; }
                }

                // Level 4 (BARU): Pola (Pattern)
                else if (currentLevel === 4) {
                    // Cek kode error pattern yang kita buat di Python
                    const hasPatternError = data.weaknesses.some(w => 
                        w === "BRUTEFORCE_SEQUENCE" || 
                        w === "BRUTEFORCE_REPEAT" || 
                        w === "BRUTEFORCE_KEYBOARD"
                    );
                    
                    if (hasPatternError) {
                        errorText = "Gagal: Pola mudah ditebak terdeteksi (urutan, keyboard, atau pengulangan).";
                    } else { passed = true; }
                }

                // Level 5: Dictionary
                else if (currentLevel === 5) {
                    const isDict = data.weaknesses.some(w => w.includes("DICTIONARY"));
                    if (isDict) { 
                        errorText = "Gagal: Password terdeteksi di dalam kamus (Dictionary Attack)."; 
                    } else { passed = true; }
                }

                // Level 6: Hybrid
                else if (currentLevel === 6) {
                    const isHybrid = data.weaknesses.some(w => w.includes("HYBRID"));
                    const isDict = data.weaknesses.some(w => w.includes("DICTIONARY"));
                    const hasPattern = data.weaknesses.some(w => w.includes("BRUTEFORCE_SEQUENCE") || w.includes("BRUTEFORCE_REPEAT") || w.includes("BRUTEFORCE_KEYBOARD"));

                    if (isHybrid) { 
                        errorText = "Gagal: Pola Hybrid terdeteksi (Kata + Angka). Buat lebih acak."; 
                    } else if (isDict) { 
                        errorText = "Gagal: Password jadi mirip kata kamus. Ubah strukturnya."; 
                    } else if (hasPattern) {
                        errorText = "Gagal: Jangan kembali menggunakan pola sederhana (abc/123).";
                    } else { 
                        passed = true; 
                        savedPassword = password; // Simpan untuk Level 7
                    }
                }

                // --- EKSEKUSI ---
                if (passed) {
                    currentLevel++;
                    updateUI();
                    msg.textContent = "";
                } else {
                    msg.textContent = errorText;
                    msg.className = "error";
                }
            })
            .catch(err => { console.error(err); msg.textContent = "Error koneksi server."; });
        });

        function updateUI() {
            levelNum.textContent = currentLevel;
            instrText.textContent = levels[currentLevel];
            
            // Hitung Progress Bar (100 / 7)
            const progressPercent = (currentLevel / 7) * 100;
            progressBar.style.width = progressPercent + "%";

            // Khusus Level Terakhir (7)
            if (currentLevel === 7) {
                input.value = ""; // KOSONGKAN INPUT
                input.placeholder = "Ingat kembali password tadi...";
                btn.textContent = "Cek Ingatan";
            }
        }

        toggleBtn.addEventListener("click", function() {
            const type = input.getAttribute("type") === "password" ? "text" : "password";
            input.setAttribute("type", type);
            this.innerHTML = type === "text" ? 
                `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.83 9L15 12.16V12a3 3 0 0 0-3-3h-.17zm-4.3.8l1.55 1.55c-.05.21-.08.42-.08.65a3 3 0 0 0 3 3c.22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53a5 5 0 0 1-5-5c0-.79.2-1.53.53-2.2zm-2.53 1.3c-.25.59-.46 1.2-.63 1.84-.15.56-.25 1.14-.29 1.73 1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42 1.57 1.27-1.27-16.9-16.9-1.27 1.27.98 3.62c-.65.4-1.25.87-1.78 1.4zm15.32-1.5c.37.65.68 1.33.91 2.05.15-.56.25-1.14.29-1.73-1.73-4.39-6-7.5-11-7.5-.31 0-.62.01-.92.04L12 4.8l2.46 2.46c1.92.57 3.52 1.87 4.32 3.66zM12 7c1.63 0 3.06.85 3.92 2.13l-5.8 5.8C9.29 14.27 8.5 13.22 8.5 12c0-1.93 1.57-3.5 3.5-3.5z"/></svg>` : 
                `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
        });
    </script>
</body>
</html>